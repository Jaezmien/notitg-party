<ActorFrame
	OnCommand="%function(self)
		Lemonade:Send(2, {3, 1}) -- Let's report to the client that we are in the room screen

		PARTY_CMD.renderRoomUsers = function(a)
			local t = a('Text')	
			local y = 0

			for i,v in pairs(PARTY_CMD.room.users) do
				if v.id ~= PARTY_CMD.room.userid then
					t:zoom(0.3)
					t:horizalign('left')
					t:settext(v.username)	
					t:y(y)

					if v.state == PARTY_CMD.CLIENT_GAME_LOADING or
							v.state == PARTY_CMD.CLIENT_GAME_READY or
							v.state == PARTY_CMD.CLIENT_PLAYING or
							v.state == PARTY_CMD.CLIENT_RESULTS then
						t:diffuse(0,0,1,1)
					elseif PARTY_CMD.room.hostid == v.id then
						t:diffuse(1,1,0,1)
					elseif v.state == PARTY_CMD.CLIENT_MISSING_SONG then
						t:diffuse(1,0,0,1)
					elseif v.state == PARTY_CMD.CLIENT_LOBBY_READY then
						t:diffuse(0,1,0,1)
					else
						t:diffuse(1,1,1,1)
					end

					t:Draw()

					y = y + 30
				end
			end
		end
	end"
	StepP1LeftPressMessageCommand="%function(self)
	end"
	StepP1DownPressMessageCommand="%function(self)
	end"
	StepP1UpPressMessageCommand="%function(self)
		if GAMESTATE:GetCurrentSong() and PARTY_CMD.room.hasSong and not PARTY_CMD:IsRoomPlaying() then
			PARTY_CMD:ToggleSelfState()	
		end
	end"
	StepP1RightPressMessageCommand="%function(self)
	end"
	StepP1MenuStartPressMessageCommand="%function(self)
		-- HACK: For some reason, this gets called a bajillion times
		-- So, we're running a queuecommand, and we reset it every time this MessageCommand gets called
		self:stoptweening()
		self:sleep(0.02)
		self:queuecommand('Debounce')
	end"
	DebounceCommand="%function(self)
		if PARTY_CMD:IsUserHost() then
			if not PARTY_CMD:RoomAllReady() then
				-- i'd force style,single here so that it makes sense
				-- but i keep getting 'too many players joined for ONE_PLAYER_ONE_CREDIT'
				-- oh well
				GAMESTATE:ApplyGameCommand('playmode,regular')
				GAMESTATE:ApplyGameCommand('style,versus')
				SCREENMAN:SetNewScreen('ScreenPartySelectMusic')
			else
				PARTY_CMD:StartRoom()
			end
		end
	end"
><children>
	<!-- Miscellaneous Values -->
	<Layer
		Type="Quad"
		Name="song state manager"
		OnCommand="%function(self)
			PARTY_CMD.__roomsong = nil 

			self:hidden(1)
			self:queuecommand('Update')
		end"
		UpdateCommand="%function(self)
			if GAMESTATE:GetCurrentSong() then
				if PARTY_CMD.__roomsong ~= GAMESTATE:GetCurrentSong() then
					PARTY_CMD.__roomsong = GAMESTATE:GetCurrentSong()
					MESSAGEMAN:Broadcast('PartyRoomSong')
				end
			else
				if PARTY_CMD.__roomsong ~= nil then
					PARTY_CMD.__roomsong = nil 
					MESSAGEMAN:Broadcast('PartyRoomNoSong')
				end
			end

			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>
	<Layer
		Type="Quad"
		InitCommand="hidden,1"
		Name="song beat"
		PartyRoomSongMessageCommand="stoptweening;queuecommand,Update"
		UpdateCommand="%function(self)
			local p = self:GetParent():GetChild('song preview')
			if p and p:get() then
				local t = p:get():GetSoundPosition()	
				local s = GAMESTATE:GetCurrentSong()
				local b = s:GetBeatFromElapsedTime(t)
				self:aux(b)
			end
			self:sleep(0.02)
			self:queuecommand('Update')
		end"
		PartyRoomNoSongMessageCommand="stoptweening;aux,0"
	/>

	<!-- Background -->
	<Layer
		Type="Sprite"
		Name="song background"
		PartyRoomSongMessageCommand="%function(self)
			local song = GAMESTATE:GetCurrentSong()
			
			if song:GetBackgroundPath() then
				self:LoadBackground(song:GetBackgroundPath())
				self:scaletocover(0,0,SCREEN_WIDTH,SCREEN_HEIGHT)
				self:diffusealpha(0.2)
				self:hidden(0)
			else
				self:hidden(1)
			end
		end"
		PartyRoomNoSongMessageCommand="%function(self)
			self:hidden(1)
		end"
		InitCommand="queuecommand,Update"
		UpdateCommand="%function(self)
			if PARTY_CMD.GetPartyProfile().ReducedEffects then return end

			local b = self:GetParent():GetChild('song beat'):getaux()
			local bt = math.mod(b, 1)
			local et = 1-(1-bt)*(1-bt)

			self:zoom(1 + (1-et)*0.05)

			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>

	<!-- Room Details -->
	<Layer
		Type="BitmapText"
		Font="_wendy white"
		Text="room name"
		OnCommand="xy,SCREEN_WIDTH-30,60;horizalign,right;zoom,0.35;maxwidth,SCREEN_WIDTH*1.5;queuecommand,Update"
		UpdateCommand="%function(self)
			self:settext(PARTY_CMD.room.title)
			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>
	<Layer
		Type="BitmapText"
		Font="_wendy white"
		Text="room id"
		OnCommand="xy,SCREEN_WIDTH-30,90;horizalign,right;zoom,0.2;queuecommand,Update"
		UpdateCommand="%function(self)
			self:settext(PARTY_CMD.room.id)
			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>

	<!-- Room Players -->
	<Layer
		Type="BitmapText"
		Font="_wendy white"
		Text="room user"
		OnCommand="xy,20,60;horizalign,left;zoom,0.5;queuecommand,Update"
		UpdateCommand="%function(self)
			local u = PARTY_CMD:GetOwnUser()
			if u ~= nil then
				if u.state == PARTY_CMD.CLIENT_LOBBY_READY then
					self:diffuse(0,1,0,1)
				elseif PARTY_CMD:IsUserHost() then
					self:diffuse(1,1,0,1)
				else
					self:diffuse(1,1,1,1)
				end

				self:settext(u.username)
			else
				self:settext('')
			end

			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>

	<Layer
		Type="ActorFrame"
		Name="room players"
		InitCommand="xy,20,100"
		OnCommand="%function(self)
			self:SetDrawFunction(PARTY_CMD.renderRoomUsers)
		end"	
	><children>
		<Layer
			Type="BitmapText"
			Font="_wendy white"
			Name="Text"
			OnCommand="horizalign,left;zoom,0.5"
		/>
	</children></Layer>

	<!-- Instructions -->
	<Layer
		Type="BitmapText"
		Font="_misoreg white"
		Text="instruction host"
		OnCommand="xy,SCREEN_WIDTH-30,SCREEN_CENTER_Y+155;horizalign,right;zoom,0.4;maxwidth,SCREEN_WIDTH*1.75;queuecommand,Update"
		UpdateCommand="%function(self)
			if PARTY_CMD:IsUserHost() then
				if PARTY_CMD:RoomAllReady() and GAMESTATE:GetCurrentSong() then
					self:settext('All players are ready! Press &START; to start.')
				else
					self:settext('Press &START; to pick a song')
				end
			else
				self:settext('')
			end

			if not PARTY_CMD.GetPartyProfile().ReducedEffects then
				local b = self:GetParent():GetChild('song beat'):getaux()
				local bt = math.mod(b, 1)
				if bt > 0.5 then self:diffuse(1,1,1,0.5) else self:diffuse(1,1,1,1) end
			end

			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>
	<Layer
		Type="BitmapText"
		Font="_misoreg white"
		Text="instruction player"
		OnCommand="xy,SCREEN_WIDTH-30,SCREEN_CENTER_Y+180;horizalign,right;zoom,0.4;maxwidth,SCREEN_WIDTH*1.75;queuecommand,Update"
		UpdateCommand="%function(self)
			if GAMESTATE:GetCurrentSong() then
				local u = PARTY_CMD:GetOwnUser()

				if u and u.state == PARTY_CMD.CLIENT_IDLE then
					self:settext('Press &UP; to get ready!')
				elseif u and u.state == PARTY_CMD.CLIENT_LOBBY_READY then
					self:settext('Press &UP; to stop being ready!')
				elseif u and u.state == PARTY_CMD.CLIENT_MISSING_SONG then
					self:settext('You are missing this song!')
				else
					self:settext('')
				end

				if PARTY_CMD:IsRoomPlaying() then
					self:settext('Waiting for match to end!')
				end
			else
				local u = PARTY_CMD:GetOwnUser()

				if u and u.state == PARTY_CMD.CLIENT_MISSING_SONG then
					self:settext('You are missing this song!')
				else
					self:settext('')
				end
			end

			if not PARTY_CMD.GetPartyProfile().ReducedEffects then
				local b = self:GetParent():GetChild('song beat'):getaux()
				local bt = math.mod(b, 1)
				if bt > 0.5 then self:diffuse(1,1,1,0.5) else self:diffuse(1,1,1,1) end
			end

			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>

	<!-- Song Details -->
	<Layer
		Type="BitmapText"
		Font="_misobold outline"
		Text="song title"
		OnCommand="xy,SCREEN_WIDTH-30,SCREEN_CENTER_Y;horizalign,right;zoom,0.6;maxwidth,SCREEN_WIDTH*1.0;queuecommand,Update"
		UpdateCommand="%function(self)
			if GAMESTATE:GetCurrentSong() then
				self:settext(GAMESTATE:GetCurrentSong():GetDisplayMainTitle())
			else
				if PARTY_CMD.room.hasSong then
					self:settext('No song selected!')
				else
					self:settext('Simfile Missing!')
				end
			end
			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>
	<Layer
		Type="BitmapText"
		Font="_misoreg white"
		Text="song artist"
		OnCommand="xy,SCREEN_WIDTH-30,SCREEN_CENTER_Y+28;horizalign,right;zoom,0.4;maxwidth,SCREEN_WIDTH*1.0;queuecommand,Update"
		UpdateCommand="%function(self)
			if GAMESTATE:GetCurrentSong() then
				self:settext(GAMESTATE:GetCurrentSong():GetDisplayArtist())
			else
				self:settext('')
			end
			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>
	<Layer
		Type="BitmapText"
		Font="_misoreg small"
		Text="song folder"
		OnCommand="xy,SCREEN_WIDTH-30,SCREEN_CENTER_Y+50;horizalign,right;zoom,0.4;maxwidth,SCREEN_WIDTH*1.75;queuecommand,Update"
		UpdateCommand="%function(self)
			if GAMESTATE:GetCurrentSong() then
				self:settext(GAMESTATE:GetCurrentSong():GetGroupName())
			else
				self:settext('')
			end
			self:sleep(0.02)
			self:queuecommand('Update')
		end"
	/>
	<Layer
		Type="ActorFrame"
		OnCommand="xy,SCREEN_WIDTH-30-15,SCREEN_CENTER_Y+85;queuecommand,Update"
		UpdateCommand="sleep,0.02;queuecommand,Update"
	><children>
		<Actor
			File="@THEME:GetPath(EC_GRAPHICS,'','_difficulty icons')"
			InitCommand="%function(self) self:y(IconY()) IconCrop(self) end"
			OnCommand="animate,0"
			UpdateCommand="%function(self,parent)
				if GAMESTATE:GetCurrentSong() then
					self:hidden(0)
					SetDifficultyFrameFromGameState(self, PLAYER_1)
				else
					self:hidden(1)
				end
			end"
		/>
		<Actor
			Class="DifficultyMeter"
			Type="ScreenGameplay DifficultyMeterP1"
			UpdateCommand="%function(self) 
				if GAMESTATE:GetCurrentSong() then
					if GAMESTATE:GetCurrentTrail(PLAYER_1) then 
						self:SetFromTrail(GAMESTATE:GetCurrentTrail(PLAYER_1)) 
					else
						self:SetFromSteps(GAMESTATE:GetCurrentSteps(PLAYER_1))
					end

					P1Difficulty = self:GetChild('Difficulty'):GetText()
					self:hidden(0)
				else
					self:hidden(1)
				end
			end"
		/>
		<Layer 
			Font="_misobold small"
			Text="???" 
			OnCommand="x,-25;y,2;zoom,0.4;shadowlength,0;horizalign,right;maxwidth,240" 
			UpdateCommand="%function(self)
				if GAMESTATE:GetCurrentSong() then
					self:settext(P1Difficulty)
					self:hidden(0)
				else
					self:hidden(1)
				end
			end" 
		/>		
		<Layer 
			Condition="not GAMESTATE:IsCourseMode()"
			Font="_misobold small"
			Text="???" 
			OnCommand="x,-25;y,-12;zoom,0.4;shadowlength,0;horizalign,right;maxwidth,240"
			UpdateCommand="%function(self)
				if GAMESTATE:GetCurrentSong() then
					self:settext(GetStepsDescriptionText(PLAYER_1))
					self:hidden(0)
				else
					self:hidden(1)
				end
			end" 
		/>		
	</children></Layer>

	<Layer
		Type="ActorSound"
		File="silent.ogg"
		Name="song preview"
		OnCommand="queuecommand,Update"
		UpdateCommand="%function(self)
			local sound = self:get()

			if sound and sound:IsPlaying() then
				local p = sound:GetSoundPosition()
				local song = GAMESTATE:GetCurrentSong()
				local mi = song:GetSampleStartSeconds()
				local ma = mi + song:GetSampleLengthSeconds()

				local vol = 0.7
				local fadelen = 0.5
				if p > ma - 1 then
					local start = ma - fadelen
					local len = ma - mi
					local t = math.max(0, math.min(1, (p - start) / fadelen))
					local et = t*t -- inQuad
					vol = (1-et) * vol
				end
				sound:volume(vol)

				if p >= ma then
					sound:SetSoundPosition(mi)
					self:sleep(1.0)
				end
			end

			self:sleep(0.02)
			self:queuecommand('Update')
		end"
		PartyRoomSongMessageCommand="%function(self)
			if not PARTY_CMD.GetPartyProfile().SongPreview then return end

			local song = GAMESTATE:GetCurrentSong()

			self:stop()
			self:load( song:GetMusicPath() )
			self:start()
			self:get():volume(0)
			self:get():SetSoundPosition( song:GetSampleStartSeconds() )

			self:aux(1)
		end"
		PartyRoomNoSongMessageCommand="%function(self)
			self:aux(0)

			local sound = self:get()
			if not sound then return end

			sound:Pause(false)
			sound:Stop()
		end"
	/>

	<!-- Banner -->
	<Layer
		Type="Sprite"
		Name="song banner"
		PartyRoomSongMessageCommand="%function(self)
			local song = GAMESTATE:GetCurrentSong()
			
			if song:GetBannerPath() then
				local w = 418
				local h = 164
				local r = w/h
		
				self:LoadBanner(song:GetBannerPath())
				self:SetWidth(w)
				self:SetHeight(h)
				self:zoom(0.5)
				self:horizalign('right')
				self:xy(SCREEN_WIDTH - 30,SCREEN_CENTER_Y - 65)
				self:hidden(0)
			else
				self:hidden(1)
			end
		end"
		PartyRoomNoSongMessageCommand="%function(self)
			self:hidden(1)
		end"
	/>
</children></ActorFrame>
